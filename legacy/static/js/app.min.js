// Fiona Editor - Condensed Version
const $ = (s, p=document) => p.querySelector(s);
const $$ = (s, p=document) => p.querySelectorAll(s);
const E = (t, a, h) => Object.assign(document.createElement(t), a, h ? {innerHTML: h} : {});
const C = (m) => { const t = E('div', {className: 'toast'}, m); $('body').appendChild(t); setTimeout(() => t.remove(), 2400); };

// Core state
let s = { b: null, a: null, z: 1, p: 'default', h: [], i: -1, g: true, l: {a: true, o: 'light'}, m: false }, 
    w = {x: 0, y: 0}, t = new Map(), ps = new Map(), pc = 'default';

// Init
function init() {
    // Load layout, setup events, etc.
    setupEvents();
    loadSettings();
    boot();
}

function setupEvents() {
    // Keyboard shortcuts
    $(document).addEventListener('keydown', e => {
        if (e.key === 'Delete' && s.b) deleteBlock(s.b);
        if (e.ctrlKey && e.key === 's') { e.preventDefault(); saveLayout(); }
        if (e.ctrlKey && e.key === 'z') e.preventDefault() && (e.shiftKey ? redo() : undo());
    });
    
    // UI events
    $('#export-pdf').onclick = showExportOptions;
    $('#clear-canvas').onclick = clearCanvas;
    $('#duplicate-block')?.onclick = () => s.b && duplicateBlock(s.b);
    $('#delete-block')?.onclick = () => s.b && deleteBlock(s.b);
    $('#bring-forward')?.onclick = () => s.b && adjustZ('up');
    $('#send-backward')?.onclick = () => s.b && adjustZ('down');
    
    // Block layer events
    $('#block-layer').addEventListener('click', e => {
        if (e.target === $('#block-layer')) selectBlock(null);
    });
}

// Block operations
function createBlock(t, o = {}) {
    const b = E('div', {className: `block ${t}-block`, dataset: {type: t, id: genId()}});
    b.innerHTML = `<div class="block-controls">
        <button class="handle move"></button>
        <button class="handle resize"></button>
    </div><div class="block-inner" contenteditable="false">${o.content || sampleContent(t)}</div>`;
    
    Object.assign(b.style, {
        left: (o.x || 100) + 'px',
        top: (o.y || 100) + 'px',
        width: (o.w || 200) + 'px',
        height: (o.h || 150) + 'px',
        background: o.bg || '#fff'
    });
    
    b.onclick = () => selectBlock(b);
    b.querySelector('.block-inner').onclick = e => {
        e.stopPropagation();
        selectBlock(b);
        startEdit(b);
    };
    
    $('#block-layer').appendChild(b);
    selectBlock(b);
    scheduleSave('create');
    C(`${t} block created`);
    return b;
}

function selectBlock(b) {
    s.b?.classList.remove('selected');
    s.b = b;
    s.b?.classList.add('selected');
    updateInspector();
}

function deleteBlock(b) {
    b?.remove();
    selectBlock(null);
    scheduleSave('delete');
    C('Block deleted');
}

function duplicateBlock(b) {
    if (!b) return;
    const r = b.getBoundingClientRect();
    createBlock(b.dataset.type, {
        x: r.left + 20, y: r.top + 20, 
        w: r.width, h: r.height,
        content: b.querySelector('.block-inner').innerHTML,
        bg: getComputedStyle(b).background
    });
    C('Block duplicated');
}

function adjustZ(dir) {
    if (!s.b) return;
    const z = parseInt(s.b.style.zIndex) || 1;
    s.b.style.zIndex = dir === 'up' ? z + 1 : Math.max(1, z - 1);
    C(`Z-index ${dir === 'up' ? 'increased' : 'decreased'}`);
    scheduleSave('zindex');
}

// Editor operations
function startEdit(b) {
    const i = b.querySelector('.block-inner');
    i.contentEditable = true;
    i.focus();
    s.a = i;
    i.onblur = () => { i.contentEditable = false; s.a = null; scheduleSave('edit'); };
    i.oninput = () => scheduleSave('typing');
}

function updateInspector() {
    if (!s.b) return;
    const r = s.b.getBoundingClientRect();
    $('#inspector-x')?.value = Math.round(r.left);
    $('#inspector-y')?.value = Math.round(r.top);
    $('#inspector-width')?.value = r.width;
    $('#inspector-height')?.value = r.height;
    // Update other inspector fields...
}

// Layout operations
function serialize() {
    return Array.from($$('#block-layer .block')).map(b => ({
        id: b.dataset.id,
        type: b.dataset.type,
        x: parseInt(b.style.left),
        y: parseInt(b.style.top),
        w: parseInt(b.style.width),
        h: parseInt(b.style.height),
        content: b.querySelector('.block-inner').innerHTML
    }));
}

function saveLayout() {
    fetch('/save-layout', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({layout: serialize(), project: s.p})
    });
    C('Layout saved');
}

function scheduleSave(label) {
    // Debounced save
    clearTimeout(w.t);
    w.t = setTimeout(() => saveLayout(), 500);
}

// Export options
function showExportOptions() {
    const m = E('div', {className: 'modal'}, `
        <h3>PDF Export</h3>
        <button onclick="exportPDF(false)">Vector (Fast)</button>
        <button onclick="exportPDF(true)">Snapshot (Quality)</button>
        <button onclick="this.parentElement.remove()">Cancel</button>
    `);
    $('body').appendChild(m);
}

async function exportPDF(useSnap) {
    const m = $('.modal');
    m && m.remove();
    C('Exporting PDF...');
    
    const r = await fetch('/export/pdf', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({layout: serialize(), useSnapshotMethod: useSnap, dpi: 150})
    });
    
    if (r.ok) {
        const b = await r.blob();
        const u = URL.createObjectURL(b);
        const a = E('a', {href: u, download: 'fiona-layout.pdf'});
        a.click();
        URL.revokeObjectURL(u);
        C('PDF exported!');
    } else {
        C('Export failed');
    }
}

// History
function undo() { /* undo logic */ }
function redo() { /* redo logic */ }

// Settings
async function loadSettings() {
    const r = await fetch('/api/settings');
    s.l = await r.json();
}

// Boot
async function boot() {
    // Load initial layout
    const r = await fetch('/layout');
    const layout = await r.json();
    // Render blocks from layout...
    
    // Add sample blocks if empty
    if (!layout.blocks?.length) {
        createBlock('headline', {x: 50, y: 50, w: 400, h: 80});
        createBlock('body', {x: 50, y: 150, w: 300, h: 200});
    }
}

function genId() { return 'b_' + Date.now() + Math.random().toString(36).substr(2, 5); }

function sampleContent(t) {
    const samples = {
        headline: 'Headline text',
        body: 'Body text here...',
        image: '<div class="image-placeholder">Image</div>'
    };
    return samples[t] || 'Edit me';
}

// Initialize
document.addEventListener('DOMContentLoaded', init);